<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å‘Šç³»ç»Ÿæµ‹è¯• - Advertisement System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .ad-preview {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 8px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-ad {
            border: 2px solid #007bff;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª å¹¿å‘Šç³»ç»Ÿé›†æˆæµ‹è¯• (Advertisement System Integration Test)</h1>
    
    <div class="test-section">
        <h2>1. API è¿æ¥æµ‹è¯• (API Connection Test)</h2>
        <button onclick="testAPIConnection()">æµ‹è¯• API è¿æ¥</button>
        <div id="api-status"></div>
        <pre id="api-response"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. å¹¿å‘Šç±»å‹é¢„è§ˆ (Ad Type Previews)</h2>
        <p>æµ‹è¯•ä¸‰ç§å¹¿å‘Šç±»å‹çš„æ¸²æŸ“æ•ˆæœ</p>
        
        <h3>Card ç±»å‹ (Card Type)</h3>
        <div class="test-ad">
            <button onclick="renderTestAd('card')">æ¸²æŸ“ Card å¹¿å‘Š</button>
            <div class="ad-preview" id="card-preview"></div>
        </div>
        
        <h3>Banner ç±»å‹ (Banner Type)</h3>
        <div class="test-ad">
            <button onclick="renderTestAd('banner')">æ¸²æŸ“ Banner å¹¿å‘Š</button>
            <div class="ad-preview" id="banner-preview"></div>
        </div>
        
        <h3>Iframe ç±»å‹ (Iframe Type)</h3>
        <div class="test-ad">
            <button onclick="renderTestAd('iframe')">æ¸²æŸ“ Iframe å¹¿å‘Š</button>
            <div class="ad-preview" id="iframe-preview"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>3. æ•°æ®è¿‡æ»¤æµ‹è¯• (Data Filtering Test)</h2>
        <button onclick="testDateFiltering()">æµ‹è¯•æ—¥æœŸè¿‡æ»¤</button>
        <div id="filter-status"></div>
    </div>
    
    <div class="test-section">
        <h2>4. ä¼˜å…ˆçº§æ’åºæµ‹è¯• (Priority Sorting Test)</h2>
        <button onclick="testPrioritySorting()">æµ‹è¯•ä¼˜å…ˆçº§æ’åº</button>
        <div id="priority-status"></div>
    </div>

    <script>
        // Test data
        const testAds = {
            card: {
                id: 'test-card-001',
                type: 'card',
                priority: 'high',
                url: 'https://example.com',
                title: 'æµ‹è¯•å¡ç‰‡å¹¿å‘Š',
                content: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¡ç‰‡å¹¿å‘Šçš„æè¿°å†…å®¹ï¼Œå±•ç¤ºèµåŠ©å•†ä¿¡æ¯ã€‚',
                imageUrl: 'https://via.placeholder.com/300x200?text=Test+Card+Image',
                tag: 'æµ‹è¯•èµåŠ©å•†'
            },
            banner: {
                id: 'test-banner-001',
                type: 'banner',
                priority: 'medium',
                url: 'https://example.com',
                title: 'æµ‹è¯•æ¨ªå¹…å¹¿å‘Š',
                imageUrl: 'https://via.placeholder.com/728x90?text=Test+Banner+Ad',
                tag: 'æµ‹è¯•æ¨ªå¹…'
            },
            iframe: {
                id: 'test-iframe-001',
                type: 'iframe',
                priority: 'low',
                url: 'https://example.com',
                title: 'æµ‹è¯• Iframe å¹¿å‘Š',
                tag: 'æµ‹è¯• Iframe'
            }
        };

        // Test API connection
        async function testAPIConnection() {
            const statusDiv = document.getElementById('api-status');
            const responseDiv = document.getElementById('api-response');
            
            statusDiv.innerHTML = '<div class="status warning">â³ æ­£åœ¨æµ‹è¯•...</div>';
            
            try {
                // Test health endpoint
                const healthResponse = await fetch('/api/ads');
                const healthData = await healthResponse.json();
                
                if (healthResponse.ok) {
                    statusDiv.innerHTML = '<div class="status success">âœ“ API è¿æ¥æˆåŠŸï¼</div>';
                    responseDiv.textContent = JSON.stringify(healthData, null, 2);
                } else {
                    statusDiv.innerHTML = `<div class="status warning">âš  API è¿”å›é”™è¯¯çŠ¶æ€: ${healthResponse.status}<br>è¿™å¯èƒ½æ˜¯å› ä¸ºä½¿ç”¨äº†æµ‹è¯•å‡­è¯</div>`;
                    responseDiv.textContent = JSON.stringify(healthData, null, 2);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">âœ— API è¿æ¥å¤±è´¥: ${error.message}<br>è¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ</div>`;
                responseDiv.textContent = error.stack;
            }
        }

        // Render test ad
        function renderTestAd(type) {
            const previewDiv = document.getElementById(`${type}-preview`);
            const ad = testAds[type];
            
            previewDiv.innerHTML = '';
            
            switch (type) {
                case 'card':
                    previewDiv.innerHTML = `
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <img src="${ad.imageUrl}" alt="${ad.title}" style="max-width: 300px; border-radius: 8px;">
                            <div>
                                <h3>${ad.title}</h3>
                                <p>${ad.content}</p>
                                <a href="${ad.url}" target="_blank" style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">äº†è§£æ›´å¤š â†’</a>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'banner':
                    previewDiv.innerHTML = `
                        <a href="${ad.url}" target="_blank">
                            <img src="${ad.imageUrl}" alt="${ad.title}" style="max-width: 100%; display: block;">
                        </a>
                    `;
                    break;
                    
                case 'iframe':
                    previewDiv.innerHTML = `
                        <iframe src="${ad.url}" 
                                title="${ad.title}" 
                                style="width: 100%; height: 400px; border: 1px solid #ddd; border-radius: 4px;"
                                sandbox="allow-scripts allow-forms allow-popups">
                        </iframe>
                    `;
                    break;
            }
        }

        // Test date filtering
        function testDateFiltering() {
            const statusDiv = document.getElementById('filter-status');
            const now = new Date();
            
            const testCases = [
                {
                    name: 'æœªæ¥å¹¿å‘Šï¼ˆåº”è¯¥ä¸æ˜¾ç¤ºï¼‰',
                    ad: { startDate: new Date(now.getTime() + 86400000) },
                    expected: false
                },
                {
                    name: 'è¿‡æœŸå¹¿å‘Šï¼ˆåº”è¯¥ä¸æ˜¾ç¤ºï¼‰',
                    ad: { endDate: new Date(now.getTime() - 86400000) },
                    expected: false
                },
                {
                    name: 'æ´»è·ƒå¹¿å‘Šï¼ˆåº”è¯¥æ˜¾ç¤ºï¼‰',
                    ad: { 
                        startDate: new Date(now.getTime() - 86400000),
                        endDate: new Date(now.getTime() + 86400000)
                    },
                    expected: true
                }
            ];
            
            let html = '<h4>æµ‹è¯•ç»“æœï¼š</h4><ul>';
            let allPassed = true;
            
            testCases.forEach(testCase => {
                const result = shouldShowAd(testCase.ad);
                const passed = result === testCase.expected;
                allPassed = allPassed && passed;
                
                html += `<li style="color: ${passed ? 'green' : 'red'}">
                    ${passed ? 'âœ“' : 'âœ—'} ${testCase.name}: ${passed ? 'é€šè¿‡' : 'å¤±è´¥'}
                </li>`;
            });
            
            html += '</ul>';
            html = `<div class="status ${allPassed ? 'success' : 'error'}">${html}</div>`;
            statusDiv.innerHTML = html;
        }
        
        // Simple shouldShowAd for testing
        function shouldShowAd(ad) {
            const now = new Date();
            if (ad.startDate && now < ad.startDate) return false;
            if (ad.endDate && now > ad.endDate) return false;
            return true;
        }

        // Test priority sorting
        function testPrioritySorting() {
            const statusDiv = document.getElementById('priority-status');
            
            const unsortedAds = [
                { id: '1', priority: 'low', title: 'Low Priority' },
                { id: '2', priority: 'high', title: 'High Priority' },
                { id: '3', priority: 'medium', title: 'Medium Priority' },
                { id: '4', priority: 'high', title: 'Another High' }
            ];
            
            const sorted = sortAdsByPriority(unsortedAds);
            
            let html = '<h4>æ’åºç»“æœï¼š</h4><ol>';
            sorted.forEach(ad => {
                html += `<li>${ad.title} (${ad.priority})</li>`;
            });
            html += '</ol>';
            
            const correctOrder = sorted[0].priority === 'high' && 
                                sorted[1].priority === 'high' &&
                                sorted[2].priority === 'medium' &&
                                sorted[3].priority === 'low';
            
            html = `<div class="status ${correctOrder ? 'success' : 'error'}">${html}</div>`;
            statusDiv.innerHTML = html;
        }
        
        function sortAdsByPriority(ads) {
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            return ads.slice().sort((a, b) => {
                const aPriority = priorityOrder[a.priority] || 0;
                const bPriority = priorityOrder[b.priority] || 0;
                return bPriority - aPriority;
            });
        }
    </script>
</body>
</html>
